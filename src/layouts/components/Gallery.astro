---
import "lightgallery/css/lightgallery.css";
import "lightgallery/css/lg-zoom.css";
import "lightgallery/css/lg-thumbnail.css";
import ImageMod from "./ImageMod.astro";
import { getImageImport } from "@/lib/utils/imageUtils";

/**
 * Define the structure for the image data passed via props.
 * The 'size' property is critical for smooth lightbox transitions.
 */
interface GalleryImage {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  lgSize?: string;
}

interface Props {
  id: string; // Unique ID for this specific gallery instance
  images: GalleryImage[];
}

const { id, images } = Astro.props;
---

<div id={id} class="gallery-container">
  {
    images.map(async (img) => {
      if (!img.lgSize) {
        const image = await getImageImport(img.src);
        if (image) {
          img.lgSize = `${image.width}-${image.height}`;
        }
      }
      return (
        // The anchor tag is the item that gets tiled in the Masonry layout
        <a href={img.src} data-lg-size={img.lgSize} class="gallery-item">
          <ImageMod
            src={img.src}
            alt={img.alt}
            width={img.width}
            height={img.height}
          />
        </a>
      );
    })
  }
</div>

<style>
  /* --- MASONRY LAYOUT CSS (Pure Columns) --- */
  .gallery-container {
    column-count: 4;
    column-gap: 2rem;
    width: 100%;
    margin-bottom: 2rem; /* Add space below the gallery */
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .gallery-container {
      column-count: 2;
    }
  }
  @media (max-width: 480px) {
    .gallery-container {
      column-count: 1;
    }
  }

  /* CRITICAL: Styles for the tiled items */
  .gallery-item {
    /* Prevents the block from being cut across columns */
    break-inside: avoid;

    margin-bottom: 2rem;
    display: block;
    border-radius: 8px;
    overflow: hidden;
    transition: box-shadow 0.25s;
  }

  .gallery-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

</style>

<script>
  import lightGallery from "lightgallery";
  import lgThumbnail from "lightgallery/plugins/thumbnail";
  import lgZoom from "lightgallery/plugins/zoom";

  /**
   * Initializes lightGallery on a single element.
   * @param {HTMLElement} el The container element to initialize.
   */
  const initSingleGallery = (el: HTMLElement) => {
    // Only initialize if the element exists and hasn't been initialized yet
    if (el && !el.classList.contains("lg-on")) {
      lightGallery(el, {
        plugins: [lgThumbnail, lgZoom],
        selector: ".gallery-item", // Targets the anchor tags we defined
        speed: 500,
        // Add any other lightGallery options here
      });
      el.classList.add("lg-on"); // Mark as initialized
    }
  };

  /**
   * Function to run on initial load and page navigation.
   * This is the core logic for supporting multiple galleries.
   */
  const initializeAllGalleries = () => {
    // Selects ALL elements using the specific class for this component
    // If you embed this component multiple times, this ensures all are initialized.
    const galleryContainers =
      document.querySelectorAll<HTMLElement>(".gallery-container");

    galleryContainers.forEach(initSingleGallery);
  };

  // 1. Run on initial page load
  initializeAllGalleries();

  // 2. Run after every View Transition navigation (if enabled)
  document.addEventListener("astro:page-load", initializeAllGalleries);
</script>
